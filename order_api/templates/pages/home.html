{% extends "base.html" %}
{% load static %}

{% block title %}Orders Dashboard{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1>Orders Dashboard</h1>
        {% if user.is_authenticated %}
            <p>Welcome, {{ user.name|default:user.email }}! Role: <span class="badge bg-primary">{{ user.get_role_display }}</span></p>
        {% endif %}
    </div>
</div>

{% if user.is_authenticated %}
    {% if user.role == 'client' %}
        <!-- CLIENT INTERFACE -->
        <div class="row mt-4">
            <div class="col-12">
                <h3>My Orders</h3>
                <button class="btn btn-success mb-3" data-bs-toggle="modal" data-bs-target="#addOrderModal">
                    <i class="fas fa-plus"></i> Add New Order
                </button>
            </div>
        </div>
        
        <div class="row">
            <div class="col-12">
                <div class="table-responsive">
                    <table class="table table-striped" id="clientOrdersTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Description</th>
                                <th>Price</th>
                                <th>Status</th>
                                <th>Worker</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Orders will be loaded here via JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    {% elif user.role == 'worker' %}
        <!-- WORKER INTERFACE -->
        <div class="row mt-4">
            <div class="col-md-6">
                <h3>Available Orders</h3>
                <div class="table-responsive">
                    <table class="table table-striped" id="availableOrdersTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Description</th>
                                <th>Price</th>
                                <th>Client</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Available orders will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="col-md-6">
                <h3>My Orders</h3>
                <div class="table-responsive">
                    <table class="table table-striped" id="myOrdersTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Description</th>
                                <th>Price</th>
                                <th>Client</th>
                                <th>Status</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- My orders will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    {% endif %}

    <!-- WebSocket Status -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="alert alert-info">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <strong>WebSocket Status:</strong> <span id="wsStatus">Disconnected</span>
                    </div>
                    <div>
                        <button class="btn btn-sm btn-outline-secondary me-2" onclick="initializeWebSocket()">
                            <i class="fas fa-plug"></i> Reconnect
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="disconnectWebSocket()">
                            <i class="fas fa-times"></i> Disconnect
                        </button>
                    </div>
                </div>
                <div id="wsMessages" class="mt-2" style="max-height: 200px; overflow-y: auto;"></div>
            </div>
        </div>
    </div>

{% else %}
    <!-- NOT AUTHENTICATED -->
    <div class="row mt-4">
        <div class="col-12 text-center">
            <h3>Welcome to Order API</h3>
            <p>Please <a href="{% url 'account_login' %}">sign in</a> to access your orders dashboard.</p>
        </div>
    </div>
{% endif %}

<!-- Add Order Modal (for clients) -->
{% if user.role == 'client' %}
<div class="modal fade" id="addOrderModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Order</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addOrderForm">
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" name="description" rows="3" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="price" class="form-label">Price</label>
                        <input type="number" step="0.01" class="form-control" id="price" name="price" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addOrder()">Add Order</button>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block inline_javascript %}
{% csrf_token %}
<script>
    // Global variables
    let socket = null;
    const userRole = '{{ user.role }}';
    let reconnectAttempts = 0;
    let maxReconnectAttempts = 10;
    let baseReconnectInterval = 2000; // 2 seconds
    let reconnectTimer = null;

    // Get CSRF token from Django
    function getCSRFToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]').value;
    }

    // Initialize page
    window.addEventListener('DOMContentLoaded', () => {
        console.log('Page loaded. User authenticated:', '{{ user.is_authenticated }}');
        console.log('User role:', userRole);
        console.log('CSRF Token:', getCSRFToken());
        
        if ('{{ user.is_authenticated }}' === 'True') {
            initializeWebSocket();
            loadOrders();
        }
    });

    // Clean up WebSocket on page unload
    window.addEventListener('beforeunload', () => {
        if (socket) {
            socket.close(1000, 'Page unload');
        }
    });

    // Handle page visibility changes (e.g., tab switching)
    document.addEventListener('visibilitychange', () => {
        if ('{{ user.is_authenticated }}' === 'True') {
            if (document.hidden) {
                // Page is hidden - could pause reconnection attempts
                console.log('Page hidden');
            } else {
                // Page is visible - ensure WebSocket is connected
                console.log('Page visible');
                if (!socket || socket.readyState !== WebSocket.OPEN) {
                    initializeWebSocket();
                }
            }
        }
    });

    // WebSocket Functions
    function initializeWebSocket() {
        if (socket && socket.readyState === WebSocket.OPEN) {
            return; // Already connected
        }

        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws/orders/`;
        
        console.log('Attempting to connect to WebSocket...');
        socket = new WebSocket(wsUrl);
        
        socket.onopen = function(e) {
            console.log('WebSocket connected successfully');
            updateWSStatus('Connected', 'success');
            addWSMessage('Connected to WebSocket');
            
            // Reset reconnect attempts on successful connection
            reconnectAttempts = 0;
            if (reconnectTimer) {
                clearTimeout(reconnectTimer);
                reconnectTimer = null;
            }
        };
        
        socket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            handleWebSocketMessage(data);
        };
        
        socket.onclose = function(e) {
            console.log('WebSocket connection closed:', e.code, e.reason);
            updateWSStatus('Disconnected', 'danger');
            addWSMessage(`WebSocket connection closed (Code: ${e.code})`);
            
            // Attempt to reconnect if not manually closed
            if (e.code !== 1000) { // 1000 = normal closure
                attemptReconnect();
            }
        };
        
        socket.onerror = function(e) {
            console.error('WebSocket error:', e);
            updateWSStatus('Error', 'warning');
            addWSMessage('WebSocket error occurred');
        };
    }

    function attemptReconnect() {
        if (reconnectAttempts >= maxReconnectAttempts) {
            updateWSStatus('Failed', 'danger');
            addWSMessage(`Max reconnection attempts (${maxReconnectAttempts}) reached. Please refresh the page.`);
            return;
        }

        reconnectAttempts++;
        
        // Exponential backoff: 2s, 4s, 8s, 16s, max 30s
        const delay = Math.min(baseReconnectInterval * Math.pow(2, reconnectAttempts - 1), 30000);
        
        updateWSStatus(`Reconnecting... (${reconnectAttempts}/${maxReconnectAttempts})`, 'warning');
        addWSMessage(`Attempting to reconnect in ${delay/1000}s (${reconnectAttempts}/${maxReconnectAttempts})...`);

        reconnectTimer = setTimeout(() => {
            initializeWebSocket();
        }, delay);
    }

    function disconnectWebSocket() {
        if (socket) {
            // Clear any pending reconnection
            if (reconnectTimer) {
                clearTimeout(reconnectTimer);
                reconnectTimer = null;
            }
            
            // Close with normal closure code to prevent auto-reconnect
            socket.close(1000, 'Manual disconnect');
            socket = null;
        }
    }

    function updateWSStatus(status, type) {
        const statusEl = document.getElementById('wsStatus');
        statusEl.textContent = status;
        statusEl.className = `text-${type}`;
    }

    function addWSMessage(message) {
        const messagesEl = document.getElementById('wsMessages');
        const div = document.createElement('div');
        div.className = 'text-muted small';
        div.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
        messagesEl.appendChild(div);
        messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function handleWebSocketMessage(data) {
        addWSMessage(`Received: ${data.type || 'message'}`);
        
        if (data.type === 'new_order' && userRole === 'worker') {
            addWSMessage(`New order #${data.order_id}: ${data.message}`);
            loadOrders(); // Refresh orders list
        } else if (data.type === 'order_status_update') {
            if (userRole === 'client') {
                addWSMessage(`Order #${data.order_id} status: ${data.status}`);
            } else if (userRole === 'worker') {
                addWSMessage(`Order #${data.order_id} updated: ${data.message}`);
            }
            loadOrders(); // Refresh orders list
        }
    }

    // API Functions
    async function makeApiRequest(url, options = {}) {
        const defaultOptions = {
            credentials: 'include', // Include cookies for session auth
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken(),
            },
        };
        
        // Merge options with defaults
        const mergedOptions = {
            ...defaultOptions,
            ...options,
            headers: {
                ...defaultOptions.headers,
                ...(options.headers || {}),
            },
        };
        
        const response = await fetch(url, mergedOptions);
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('API Error:', response.status, errorText);
            throw new Error(`HTTP error! status: ${response.status} - ${errorText}`);
        }
        
        // Handle empty responses (like DELETE)
        const contentType = response.headers.get('content-type');
        if (contentType && contentType.includes('application/json')) {
            return response.json();
        }
        return null;
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Order Management Functions
    async function loadOrders() {
        try {
            console.log('Loading orders...');
            const orders = await makeApiRequest('/api/orders/');
            console.log('Orders loaded:', orders);
            
            if (userRole === 'client') {
                renderClientOrders(orders);
            } else if (userRole === 'worker') {
                renderWorkerOrders(orders);
            }
        } catch (error) {
            console.error('Error loading orders:', error);
            alert('Error loading orders. Please check your login status and try again.');
        }
    }

    function renderClientOrders(orders) {
        const tbody = document.querySelector('#clientOrdersTable tbody');
        tbody.innerHTML = '';
        
        orders.forEach(order => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${order.id}</td>
                <td>${order.description}</td>
                <td>$${order.price}</td>
                <td><span class="badge bg-${getStatusColor(order.status)}">${order.status}</span></td>
                <td>${order.worker ? order.worker.name || order.worker.email : 'Unassigned'}</td>
                <td>${new Date(order.created_at).toLocaleDateString()}</td>
                <td>
                    ${getClientOrderActions(order)}
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    function getClientOrderActions(order) {
        let actions = [];
        
        // Delete button for created orders
        if (order.status === 'created') {
            actions.push(`<button class="btn btn-sm btn-danger me-1" onclick="deleteOrder(${order.id})">Delete</button>`);
        }
        
        // Cancel button for created/received orders
        if (order.status === 'created' || order.status === 'received') {
            actions.push(`<button class="btn btn-sm btn-warning me-1" onclick="cancelOrder(${order.id})">Cancel</button>`);
        }
        
        // Pay button for completed orders
        if (order.status === 'completed') {
            actions.push(`<button class="btn btn-sm btn-success me-1" onclick="payOrder(${order.id})">Pay</button>`);
        }
        
        return actions.length > 0 ? actions.join('') : '<span class="text-muted">N/A</span>';
    }

    function renderWorkerOrders(orders) {
        const availableOrders = orders.filter(order => !order.worker);
        const myOrders = orders.filter(order => order.worker);
        
        // Render available orders
        const availableTbody = document.querySelector('#availableOrdersTable tbody');
        availableTbody.innerHTML = '';
        
        availableOrders.forEach(order => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${order.id}</td>
                <td>${order.description}</td>
                <td>$${order.price}</td>
                <td>${order.owner.name || order.owner.email}</td>
                <td>${new Date(order.created_at).toLocaleDateString()}</td>
                <td>
                    <button class="btn btn-sm btn-primary" onclick="receiveOrder(${order.id})">Take Order</button>
                </td>
            `;
            availableTbody.appendChild(row);
        });
        
        // Render my orders
        const myTbody = document.querySelector('#myOrdersTable tbody');
        myTbody.innerHTML = '';
        
        myOrders.forEach(order => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${order.id}</td>
                <td>${order.description}</td>
                <td>$${order.price}</td>
                <td>${order.owner.name || order.owner.email}</td>
                <td><span class="badge bg-${getStatusColor(order.status)}">${order.status}</span></td>
                <td>${new Date(order.created_at).toLocaleDateString()}</td>
                <td>
                    ${getWorkerOrderActions(order)}
                </td>
            `;
            myTbody.appendChild(row);
        });
    }

    function getWorkerOrderActions(order) {
        let actions = [];
        
        // Complete button for received orders
        if (order.status === 'received') {
            actions.push(`<button class="btn btn-sm btn-success me-1" onclick="completeOrder(${order.id})">Complete</button>`);
            actions.push(`<button class="btn btn-sm btn-warning" onclick="cancelOrder(${order.id})">Cancel</button>`);
        }
        
        return actions.length > 0 ? actions.join('') : '<span class="text-muted">N/A</span>';
    }

    function getStatusColor(status) {
        switch(status) {
            case 'created': return 'warning';
            case 'received': return 'info';
            case 'completed': return 'success';
            case 'paid': return 'primary';
            case 'cancelled': return 'danger';
            default: return 'secondary';
        }
    }

    // Order Actions
    async function addOrder() {
        const form = document.getElementById('addOrderForm');
        const formData = new FormData(form);
        
        try {
            const orderData = {
                description: formData.get('description'),
                price: parseFloat(formData.get('price'))
            };
            
            console.log('Creating order:', orderData);
            
            const result = await makeApiRequest('/api/orders/', {
                method: 'POST',
                body: JSON.stringify(orderData)
            });
            
            console.log('Order created:', result);
            
            // Close modal and refresh orders
            const modal = bootstrap.Modal.getInstance(document.getElementById('addOrderModal'));
            modal.hide();
            form.reset();
            loadOrders();
            
            alert('Order created successfully!');
            
        } catch (error) {
            console.error('Error adding order:', error);
            alert(`Error adding order: ${error.message}`);
        }
    }

    async function deleteOrder(orderId) {
        if (!confirm('Are you sure you want to delete this order?')) {
            return;
        }
        
        try {
            await makeApiRequest(`/api/orders/${orderId}/`, {
                method: 'DELETE'
            });
            
            loadOrders();
        } catch (error) {
            console.error('Error deleting order:', error);
            alert('Error deleting order. Please try again.');
        }
    }

    async function receiveOrder(orderId) {
        try {
            await makeApiRequest(`/api/orders/${orderId}/receive/`, {
                method: 'POST'
            });
            
            loadOrders();
            alert('Order received successfully!');
        } catch (error) {
            console.error('Error receiving order:', error);
            alert('Error receiving order. Please try again.');
        }
    }

    async function completeOrder(orderId) {
        if (!confirm('Are you sure you want to mark this order as completed?')) {
            return;
        }
        
        try {
            await makeApiRequest(`/api/orders/${orderId}/complete/`, {
                method: 'POST'
            });
            
            loadOrders();
            alert('Order completed successfully!');
        } catch (error) {
            console.error('Error completing order:', error);
            alert('Error completing order. Please try again.');
        }
    }

    async function payOrder(orderId) {
        if (!confirm('Are you sure you want to pay for this order?')) {
            return;
        }
        
        try {
            await makeApiRequest(`/api/orders/${orderId}/pay/`, {
                method: 'POST'
            });
            
            loadOrders();
            alert('Payment successful!');
        } catch (error) {
            console.error('Error processing payment:', error);
            alert('Error processing payment. Please try again.');
        }
    }

    async function cancelOrder(orderId) {
        if (!confirm('Are you sure you want to cancel this order?')) {
            return;
        }
        
        try {
            await makeApiRequest(`/api/orders/${orderId}/cancel/`, {
                method: 'POST'
            });
            
            loadOrders();
            alert('Order cancelled successfully!');
        } catch (error) {
            console.error('Error cancelling order:', error);
            alert('Error cancelling order. Please try again.');
        }
    }
</script>
{% endblock %}